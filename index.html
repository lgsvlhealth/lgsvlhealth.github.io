<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <title>LGSVL Health</title>

        <style>
            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
                font-family: "San Francisco", "Helvetica Neue", "Helvetica", "Arial";
            }

            body {
                background-color: white;
            }

            .root {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .header {
                display: flex;
                flex-direction: row;
                align-items: center;
            }

            .title {
                display: flex;
                flex-direction: column;
                align-items: center;
                font-size: 3em;
            }

            .app {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .button {
              background-color: #4CAF50;
              border: none;
              color: white;
              padding: 15px 32px;
              text-align: center;
              text-decoration: none;
              display: inline-block;
              font-size: 16px;
              margin: 4px 2px;
              cursor: pointer;
            }

            #jitsi_parent {
              z-index: 0;
              width: 100%;
              height: 100%;
            }

            .ptz_button {
              background-color: #33333333;
              border: none;
              margin: 2px 2px;
              width: 60px;
              height: 60px;
            }

            .ptz_button .material-icons {
              font-size: 48px;
              color: black;
              vertical-align: center;
              text-align: center;
            }

            .ptz_button:hover  .material-icons {
              color: #555555;
            }

            .ptz_control {
                text-align: right;
                float: right;
                vertical-align: middle;
                align-items: center;
                justify-content: center;
                display: inline-flex;
                flex-direction: column;
                height: 100%;
            }

            .ptz_control_overlay {
                height: 100%;
                z-index: 99;
                opacity: 0.8;
                top: 0;
                right: 0;
                position: fixed;
            }

            .health_controls_overlay {
                height: 100%;
                z-index: 98;
                opacity: 0.8;
                top: 0;
                left: 20px;
                position: fixed;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                vertical-align: middle;
            }

            .health_control {
                display: flex;
                flex-direction: row;
                vertical-align: center;
                align-items: center;
            }

            .health_device_available {
            }

            .health_device_unavailable {
                filter: grayscale(100%);
            }

            .health_device_value {
                font-family: "San Francisco", "Helvetica Neue", "Helvetica", "Arial";
                font-size: 3em;
                text-align: center;
            }
        </style>

        <script src = "./libs/socket.io.js"></script>
        <script src='https://meet.jit.si/external_api.js'></script>
        <script src="bluetooth.js"></script>
        <script>
            var socket = io('https://kodegood.com:3000');
            var bluetooth;

            function isWebOS() {
                return navigator.userAgent.includes('WebAppManager');
            }

            function cancelDoctorCall() {

            }

            function doDoctorCall() {
                 document.getElementById("app").innerHTML = ' \
                    <button class="button" style="background-color: red;" onclick="cancelDoctorCall()">Cancel call</button> \
                    ';

                socket.emit('doctorCall', {room: "test"});

                socket.on('newAnswerDoctorCall', function(data) {
                    console.log("Doctor got answer");

                    document.getElementById("root").setAttribute("style", "display:none;");
                    document.getElementById("ptz_control_overlay").setAttribute("style", "display:block");
                    document.getElementById("health_controls_overlay").setAttribute("style", "display:flex");

                    let someID = Math.random().toString(36).substring(7);

                    var domain = "meet.jit.si";
                    var options = {
                        roomName: "LGSVLJitsiMeetHealthPOC" + someID,
                        parentNode: document.querySelector("#jitsi_parent"),
                        configOverwrite: { preferH264: true },
                    }
                    var api = new JitsiMeetExternalAPI(domain, options);
                    api.addEventListener('participantLeft', function(id) {
                        document.getElementById("app").innerHTML = ' \
                            <button class="button" style="text-align:center;" onclick="doDoctorCall()">Call client</button> \
                            ';
                        document.getElementById("root").setAttribute("style", "display:flex;");
                        document.getElementById("ptz_control_overlay").setAttribute("style", "display:none");
                        document.getElementById("health_controls_overlay").setAttribute("style", "display:none");
                        api.dispose();
                    });

                    socket.emit('doctorVideoCall', {roomName: "LGSVLJitsiMeetHealthPOC" + someID});
                });

                socket.on('heart_rate_available', function(data) {
                    var heart_overlay_elem  = document.getElementById("heart_overlay_icon");
                    if (heart_overlay_elem) {
                        heart_overlay_elem.classList.add('health_device_available');
                        heart_overlay_elem.classList.remove('health_device_unavailable');
                    }
                });

                socket.on('heart_rate', function(data) {
                    var heart_value_overlay_elem = document.getElementById("heart_value_overlay");
                    if (heart_value_overlay_elem)
                        heart_value_overlay_elem.innerHTML = data.heart_rate;
                });
            }

            function joinAsDoctor() {
                document.getElementById("app").innerHTML = ' \
                    <button class="button" style="text-align:center;" onclick="doDoctorCall()">Call client</button> \
                    ';
            }

            function answerDoctorCall() {
                document.getElementById("app").innerHTML = ' \
                    <div>Waiting for video call to start...</div> \
                    ';
                socket.emit('answerDoctorCall', {});

                socket.on('newDoctorVideoCall', function(data) {
                    console.log("Client got answer");

                    document.getElementById("root").setAttribute("style", "display:none;");
                    document.getElementById("health_controls_overlay").setAttribute("style", "display:flex");
                    document.getElementById("scan_devices_overlay_button").setAttribute("style", "display:block");

                    var domain = "meet.jit.si";
                    var options = {
                        roomName: data.roomName,
                        parentNode: document.querySelector("#jitsi_parent"),
                        configOverwrite: { preferH264: true },
                    }
                    var api = new JitsiMeetExternalAPI(domain, options);
                    api.addEventListener('participantLeft', function(id) {
                        document.getElementById("app").innerHTML = ' \
                            <div>Waiting for a call...</div> \
                            ';
                        document.getElementById("root").setAttribute("style", "display:flex;");
                        document.getElementById("health_controls_overlay").setAttribute("style", "display:none");
                        document.getElementById("scan_devices_overlay_button").setAttribute("style", "display:none");

                        api.dispose();
                    });

                    if (heartRateService !== undefined) {
                        socket.emit('heart_rate_available', {});
                    }
                });
                socket.on('newPtzCommand', function(data) {
                    console.log("PTZ command received" + JSON.stringify(data));
                    if (data.command === undefined)
                        return;
                    switch (data.command) {
                        case 'zoomIn':
                            doZoomIn();
                            break;
                        case 'zoomOut':
                            doZoomOut();
                            break;
                        case 'moveUp':
                            doMoveUp();
                            break;
                        case 'moveDown':
                            doMoveDown();
                            break;
                        case 'moveLeft':
                            doMoveLeft();
                            break;
                        case 'moveRight':
                            doMoveRight();
                            break;
                        default:
                            console.log("Unhandled PTZ command");
                    }
                });
            }

            var cameraBridge;
            var cameraHandle;
            var cameraProperties = {
                'zoomAbsolute' : 100,
                'pan' : 0,
                'tilt' : 0
            };
            const cameraServiceName = 'luna://com.webos.service.camera2';
            const getCameraListName = 'getCameraList';
            const openName = 'open'
            const getPropertiesName = 'getProperties';
            const getEventNotificationName = 'getEventNotification';
            const setPropertiesName = 'setProperties';
            const closeName = 'close';

            function setCameraProperty(key, value) {
                if (!isWebOS()) {
                    console.log("Setting camera properties is not supported ("+key+":"+value+")");
                    return;
                }
                const setPropertyBridge = new WebOSServiceBridge();
                params = {
                    handle : cameraHandle,
                    params : {}
                };
                params.params[key] = value;
                console.log("Setting " + key + " to " + value);
                setPropertyBridge.onservicecallback = function(msg) {
                    console.log("setcameraproperty msg is" + msg);
                }
                setPropertyBridge.call(cameraServiceName + "/" + setPropertiesName, JSON.stringify(params));
            }

            function doZoomIn() {
                cameraProperties.zoomAbsolute += 20;
                setCameraProperty("zoomAbsolute", cameraProperties.zoomAbsolute);
            }

            function doZoomOut() {
                cameraProperties.zoomAbsolute -= 20
                if (cameraProperties.zoomAbsolute <= 100)
                    cameraProperties.zoomAbsolute = 100;
                setCameraProperty("zoomAbsolute", cameraProperties.zoomAbsolute);
            }

            function doMoveLeft() {
                cameraProperties.pan -= 5000;
                setCameraProperty("pan", cameraProperties.pan);
            }

            function doMoveRight() {
                cameraProperties.pan += 5000;
                setCameraProperty("pan", cameraProperties.pan);
            }

            function doMoveUp() {
                cameraProperties.tilt += 5000;
                setCameraProperty("tilt", cameraProperties.tilt);
            }

            function doMoveDown() {
                cameraProperties.tilt -= 5000;
                setCameraProperty("tilt", cameraProperties.tilt);
            }

            function listenCameraProperties() {
                if (cameraBridge === undefined || cameraHandle === undefined)
                    return;
                cameraBridge.onservicecallback = function(msg) {
                    // getEventNotification hook
                    lunaResponse = JSON.parse(msg);
                    if (lunaResponse.returnValue === undefined || lunaResponse.returnValue !== true)
                        return;
                    if (lunaResponse.eventType === undefined || lunaResponse.eventType !== 'properties')
                        return;
                    if (lunaResponse.propertiesInfo === undefined)
                        return;
                    for (propertyName in lunaResponse.propertiesInfo) {
                        cameraProperties[propertyName] = lunaResponse.propertiesInfo[propertyName];
                        console.log("Camera property " + propertyName + " updated to " + cameraProperties[propertyName]);
                    }
                }
                params = {
                    handle : cameraHandle,
                    subscribe : true
                }
                cameraBridge.call(cameraServiceName + "/" + getEventNotificationName, JSON.stringify(params));
            }

            function getCameraProperties() {
                if (cameraBridge === undefined || cameraHandle === undefined)
                    return;
                cameraBridge.onservicecallback = function(msg) {
                    // getProperties hook
                    lunaResponse = JSON.parse(msg);
                    if (lunaResponse.returnValue === undefined || lunaResponse.returnValue !== true)
                        return;

                    if (lunaResponse.params === undefined)
                        return;

                    for (propertyName in lunaResponse.params) {
                        cameraProperties[propertyName] = lunaResponse.params[propertyName];
                        console.log("Camera property " + propertyName + " updated to " + cameraProperties[propertyName]);
                    }
                    console.log("Properties obtained from camera: " + JSON.stringify(cameraProperties));
                    listenCameraProperties();
                }
                const params = {
                    handle : cameraHandle
                }
                console.log(JSON.stringify(params));
                cameraBridge.call(cameraServiceName + "/" + getPropertiesName, JSON.stringify(params));
            }

            function openCamera(cameraId) {
                if (cameraBridge === undefined)
                    return;

                cameraBridge.onservicecallback = function(msg) {
                    // open hook
                    lunaResponse = JSON.parse(msg);
                    console.log("open message is "+msg);
                    if (lunaResponse.returnValue === undefined || lunaResponse.returnValue !== true)
                        return;

                    if (lunaResponse.handle === undefined)
                        return;
                    cameraHandle = lunaResponse.handle;
                    console.log("Opened camera with handle "+ cameraHandle);
                    getCameraProperties();
                }
                const params = {
                    id: cameraId,
                    mode: "primary"
                }
                cameraBridge.call(cameraServiceName + '/' + openName, JSON.stringify(params));
            }

            function initCamera() {
                cameraBridge = new WebOSServiceBridge();
                cameraBridge.onservicecallback = function(msg) {
                    // getCameraList hook
                    lunaResponse = JSON.parse(msg);
                    if (lunaResponse.deviceList !== undefined && lunaResponse.deviceList[0] !== undefined &&
                        lunaResponse.deviceList[0].id !== undefined) {
                        console.log("Camera with id " + lunaResponse.deviceList[0].id + " found");
                        openCamera(lunaResponse.deviceList[0].id);
                    } else {
                        console.error("Failed to init camera: " + msg);
                    }
                }
                cameraBridge.call(cameraServiceName+'/'+getCameraListName, '{}');
            }

            function requestCecActivateSource() {
                var cecBridge = new WebOSServiceBridge();
                cecBridge.call("luna://com.webos.service.cec/activateSource", '{}');
            }


            var healthThermometerServiceUuid = "00001809-0000-1000-8000-00805f9b34fb"
            var temperatureMeasurementUuid = "00002a1c-0000-1000-8000-00805f9b34fb";

            var thermometerService;
            var thermometerNotifications;

            function requestTemperatureDevice() {
            }

            var heartRateServiceUuid = "0000180d-0000-1000-8000-00805f9b34fb"
            var heartRateMeasurementUuid = "00002a37-0000-1000-8000-00805f9b34fb";

            var heartRate = 0;
            var heartRateDevice;
            var heartRateServer;
            var heartRateService;
            var heartRateNotifications;

            function requestHeartRateDevice() {
                var promise = new Promise(function(resolve, reject) {
                    if (heartRateDevice === undefined) {
                        bluetooth.requestDevice(heartRateServiceUuid)
                        .then(device => {
                            console.log('Found heart rate device: ' + device.name);
                            heartRateDevice = device;
                            return device.gatt.connect();
                        })
                        .then(server => {
                            console.log('Getting heart rate service...');
                            heartRateServer = server;
                            return server.getPrimaryService(heartRateServiceUuid);
                        })
                        .then(service => {
                            console.log('Getting heart rate characteristics...');
                            heartRateService = service;
                            return service.getCharacteristic(heartRateMeasurementUuid);
                        })
                        .then(characteristic => {
                            console.log('Start heart rate notifications...');
                            heartRateNotifications = characteristic;

                            var heart_elem = document.getElementById("heart_icon");
                            if (heart_elem) {
                                heart_elem.classList.add('health_device_available');
                                heart_elem.classList.remove('health_device_unavailable');
                            }
                            var heart_overlay_elem  = document.getElementById("heart_overlay_icon");
                            if (heart_overlay_elem) {
                                heart_overlay_elem.classList.add('health_device_available');
                                heart_overlay_elem.classList.remove('health_device_unavailable');
                            }

                            socket.emit('heart_rate_available', {});

                            return heartRateNotifications.startNotifications().then(_ => {
                                console.log('> Notifications started');
                                heartRateNotifications.addEventListener('characteristicvaluechanged',
                                                                        handleHeartRateNotifications);
                            });
                        })
                        .catch(error => {
                          if (heartRateServer !== undefined)
                            heartRateServer.disconnect();
                          console.log('Argh! ' + error);
                        })
                        .finally(() => {
                            Promise.resolve();
                        });
                    } else {
                        Promise.resolve();
                    }
                });
                return promise;
            }

            function handleHeartRateNotifications(event) {
                if (event.detail.changed !== undefined) {
                    heartRate = event.detail.changed.value.bytes[1];

                    var heart_value_elem = document.getElementById("heart_value");
                    if (heart_value_elem)
                        heart_value_elem.innerHTML = heartRate;

                    var heart_value_overlay_elem = document.getElementById("heart_value_overlay");
                    if (heart_value_overlay_elem)
                        heart_value_overlay_elem.innerHTML = heartRate;

                    socket.emit('heart_rate', {heart_rate: heartRate});
                }
            }

            function requestDevices() {
                requestHeartRateDevice();
            }
/*
 Example

            function requestDevices() {
                let heartRateServiceUuid = "0000180d-0000-1000-8000-00805f9b34fb"
                let heartRateMeasurementUuid = "00002a37-0000-1000-8000-00805f9b34fb";

                console.log('Requesting any Bluetooth Heart rate...');
                var connectedServer;

                bluetooth.requestDevice(heartRateServiceUuid)
                .then(device => {
                    console.log('Found ' + device.name);
                    console.log('Connecting to GATT Server...');
                    return device.gatt.connect();
                })
                .then(server => {
                    console.log('Getting Service...');
                    connectedServer = server;
                    return server.getPrimaryService(heartRateServiceUuid);
                })
                .then(service => {
                    console.log('Getting Characteristics...');
                    return service.getCharacteristic(heartRateMeasurementUuid);
                })
                .then(characteristic => {
                    heartRateNotifications = characteristic;
                    return heartRateNotifications.startNotifications().then(_ => {
                        console.log('> Notifications started');
                        heartRateNotifications.addEventListener('characteristicvaluechanged',
                                                                handleNotifications);
                    });
                })
                .catch(error => {
                  if (connectedServer !== undefined)
                    connectedServer.disconnect();
                  console.log('Argh! ' + error);
                });
            }

            // This is for Health Thermometer/Temperature Measurement

            let healthThermometerServiceUuid = "00001809-0000-1000-8000-00805f9b34fb"
            let temperatureMeasurementUuid = "00002a1c-0000-1000-8000-00805f9b34fb";

            function getFloatValue(value, offset) {
                const negative = value.getInt8(offset + 2) >>> 31;

                const [b0, b1, b2, exponent] = [
                    value.getUint8(offset),
                    value.getUint8(offset + 1),
                    value.getUint8(offset + 2),
                    value.getInt8(offset + 3)
                ];

                let mantissa = b0 | (b1 << 8) | (b2 << 16);
                if (negative)
                    mantissa |= 255 << 24;

                return mantissa * Math.pow(10, exponent);
            }

            function handleTemperatureNotifications(event) {
              if (event.detail.changed !== undefined) {
                var view = new DataView(new ArrayBuffer(5));
                let bytes = event.detail.changed.value.bytes;
                view.setUint8(1, bytes[1]);
                view.setUint8(2, bytes[2]);
                view.setUint8(3, bytes[3]);
                view.setInt8(4, bytes[4]);
                console.log("Temperature: " + getFloatValue(view, 1));
              }
            }
*/
            function joinAsClient() {
                bluetooth = new Bluetooth();
                bluetooth.startDiscovery();

                document.getElementById("app").innerHTML = ' \
                    <div style="display: flex;"> \
                        <div style="display: flex; flex-direction: column; margin: 0px 200px 0px 200px;"> \
                            <div class="health_device_value"> \
                                <h1 id="temperature_value">0</h1> \
                            </div> \
                            <image width=100 height=100 class="health_device_unavailable" id="temperature_icon" src="./assets/MedicalThermometer_Red.png"/> \
                        </div> \
                        <div style="display: flex; flex-direction: column; margin: 0px 200px 0px 200px;"> \
                            <div class="health_device_value"> \
                                <h1 id="heart_value">0</h1> \
                            </div> \
                            <image width=100 height=100 class="health_device_unavailable" id="heart_icon" src="./assets/heart_beat.png"/> \
                        </div> \
                    </div> \
                    <br><br><br><br><br><br> \
                    <button class="button" style="text-align:center;" onclick="requestDevices()">Scan devices</button><br> \
                    <br><br> \
                    <div>Waiting for a call...</div> \
                    ';
                socket.on('newDoctorCall', function(data) {
                    if (isWebOS()) {
                        var bridge = new WebOSServiceBridge();
                        var url = "luna://com.webos.notification/createAlert";
                        //bridge.onservicecallback = function (msg) { var response = JSON.parse(msg); };
                        var params = '{ \
                                        "message":"Doctor is calling", \
                                        "buttons":[ \
                                            { \
                                                "label":"accept", \
                                                "onclick":"luna://com.webos.service.applicationmanager/launch", \
                                                "buttonType": "ok", \
                                                "params": \
                                                { \
                                                    "id":"com.lgsvl.app.health", \
                                                    "params": { \
                                                        "command" : "answerDoctorCall" \
                                                    } \
                                                } \
                                            }, \
                                            { \
                                                "label":"decline", \
                                                "buttonType": "cancel" \
                                            } \
                                        ] \
                                    }';
                        bridge.call(url, params);
                        requestCecActivateSource();
                    } else {
                        document.getElementById("app").innerHTML= ' \
                        <button class="button" style="text-align:center;" onclick="answerDoctorCall()">Answer</button> \
                        ';
                    }
                });
            }

            function zoomIn() {
                console.log("Requesting zoom in");
                socket.emit('ptzCommand', {'command': 'zoomIn'});
            }
            function zoomOut() {
                socket.emit('ptzCommand', {'command': 'zoomOut'});
            }
            function moveUp() {
                socket.emit('ptzCommand', {'command': 'moveUp'});
            }
            function moveDown() {
                socket.emit('ptzCommand', {'command': 'moveDown'});
            }
            function moveLeft() {
                socket.emit('ptzCommand', {'command': 'moveLeft'});
            }
            function moveRight() {
                socket.emit('ptzCommand', {'command': 'moveRight'});
            }

            function init() {
                if (isWebOS()) {
                    initCamera();
                    joinAsClient();
                    document.addEventListener('webOSRelaunch', function(ev) {
                        if (ev.detail === undefined || ev.detail.command === undefined)
                            return;
                        switch (ev.detail.command) {
                        case 'answerDoctorCall':
                            answerDoctorCall();
                            break;
                        default:
                            console.error('Unhandled relaunch event');
                        }
                    });
                } else {
                    document.getElementById("app").innerHTML= ' \
                        <button class="button" style="text-align:center;" onclick="joinAsDoctor()">Join as Doctor</button><br> \
                        <button class="button" style="text-align:center;" onclick="joinAsClient()">Join as Client</button> \
                    ';
                }
            }

            function freeResources() {
                if (cameraBridge !== undefined && cameraHandle !== undefined) {
                    const params = {
                        handle: cameraHandle
                    }
                    cameraBridge.call(cameraServiceName + "/" + closeName, JSON.stringify(params));
                }
            }
        </script>
    </head>
    <body onload="init()" onunload="freeResources()">
        <div class="root" id="root">
            <div class="header">
                <div class="title">
                    <h1>LGSVL Health</h1>
                </div>
                <image width="200" height="200" src="./assets/Doctor_Male.png"/>
                <image width="200" height="200" src="./assets/Doctor_Female.png"/>
            </div>
            <br><br>
            <div class="app" id="app"></div>
        </div>
        <div id="jitsi_parent"></div>
        <div class="ptz_control_overlay" id="ptz_control_overlay" style="display:none">
            <div class="ptz_control" id="ptz_control">
                <button class="ptz_button" id="ptz_zoom_in_button" onclick="zoomIn()"><i class="material-icons">zoom_in</i></button>
                <button class="ptz_button" id="ptz_zoom_out_button" onclick="zoomOut()"><i class="material-icons">zoom_out</i></button>

                <button class="ptz_button" id="ptz_up_button" onclick="moveUp()"><i class="material-icons">keyboard_arrow_up</i></button>
                <button class="ptz_button" id="ptz_down_button" onclick="moveDown()"><i class="material-icons">keyboard_arrow_down</i></button>
                <button class="ptz_button" id="ptz_left_button" onclick="moveLeft()"><i class="material-icons">keyboard_arrow_left</i></button>
                <button class="ptz_button" id="ptz_right_button" onclick="moveRight()"><i class="material-icons">keyboard_arrow_right</i></button>
            </div>
        </div>
        <div class="health_controls_overlay" id="health_controls_overlay" style="display:none">
            <div class="health_control">
                <image width=60 height=60 class="health_device_unavailable" id="temperature_overlay_icon" src="./assets/MedicalThermometer_Red.png"/>
                <div class="health_device_value" style="margin-left: 50px">
                    <h1 id="temperature_value_overlay">0</h1>
                </div>
            </div>
            <div class="health_control">
                <image width=60 height=60 class="health_device_unavailable" id="heart_overlay_icon" src="./assets/heart_beat.png"/>
                <div class="health_device_value" style="margin-left: 50px">
                    <h1 id="heart_value_overlay">0</h1>
                </div>
            </div>
            <div class="health_control" id="scan_devices_overlay_button" style="display:none">
                <button class="button" style="text-align:center;" onclick="requestDevices()">Scan devices</button>
            </div>
        </div>
    </body>
</html>
